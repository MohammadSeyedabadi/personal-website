name: Save GitHub Traffic (daily)

on:
  schedule:
    - cron: '0 0 * * *'   # هر روز ساعت 00:00 UTC
  workflow_dispatch:      # امکان اجرای دستی

jobs:
  save-traffic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Get clones traffic via GitHub API
        env:
          OWNER: MohammadSeyedabadi
          REPO: personal-website
          TOKEN: ${{ secrets.GH_PAT }}
        run: |
          mkdir -p analytics
          # دریافت JSON ترافیک کلون
          resp=$(curl -s -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER/$REPO/traffic/clones")
          echo "$resp" > analytics/last_clones.json
          # استخراج count و uniques و آرایه روزانه
          count=$(echo "$resp" | jq '.count')
          uniques=$(echo "$resp" | jq '.uniques')
          date=$(date -u +"%Y-%m-%d")
          # اگر فایل CSV وجود ندارد، هدر را ایجاد کن
          if [ ! -f analytics/traffic.csv ]; then
            echo "date,total_count,total_uniques,clones_by_day_json" > analytics/traffic.csv
          fi
          # اضافه کردن یک ردیف شامل JSON روزها
          clones_json=$(echo "$resp" | jq '.clones')
          clones_json_escaped=$(echo "$clones_json" | jq -c .)
          echo "${date},${count},${uniques},\"${clones_json_escaped}\"" >> analytics/traffic.csv

      - name: Commit and push analytics
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add analytics/traffic.csv analytics/last_clones.json
          git commit -m "daily: append traffic data $(date -u +%F)" || echo "no changes to commit"
          git push origin master
